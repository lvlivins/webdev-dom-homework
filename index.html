<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link
    rel="stylesheet"
    href="styles.css"
  />
</head>

<body>
<div class="container">
  <ul
    class="comments"
    id="commentsContainer"
  >
    <li class="comment">
      <div class="comment-header">
        <div>Глеб Фокин</div>
        <div>12.02.22 12:18</div>
      </div>
      <div class="comment-body">
        <div class="comment-text">
          Это будет первый комментарий на этой странице
        </div>
      </div>
      <div class="comment-footer">
        <div class="likes">
          <span class="likes-counter">3</span>
          <button class="like-button"></button>
        </div>
      </div>
    </li>
    <li class="comment">
      <div class="comment-header">
        <div>Варвара Н.</div>
        <div>13.02.22 19:22</div>
      </div>
      <div class="comment-body">
        <div class="comment-text">
          Мне нравится как оформлена эта страница! ❤
        </div>
      </div>
      <div class="comment-footer">
        <div class="likes">
          <span class="likes-counter">75</span>
          <button class="like-button -active-like"></button>
        </div>
      </div>
    </li>
  </ul>
  <div class="add-form">
    <input
      type="text"
      class="add-form-name"
      placeholder="Введите ваше имя"
    />
    <textarea
      type="textarea"
      class="add-form-text"
      placeholder="Введите ваш коментарий"
      rows="4"
      id="textarea"
    ></textarea>
    <div class="add-form-row">
      <button
        id="btn"
        class="add-form-button"
      >Написать
      </button>
    </div>
  </div>
</div>
</body>

<script>
  "use strict";
  const inputEl = document.querySelector('.add-form-name');
  const textEl = document.querySelector('.add-form-text');
  const buttonEl = document.querySelector('.add-form-button');
  const formEl = document.querySelector('.add-form');
  const containerEl = document.querySelector('.container');

  const loadEl = document.createElement('div');
  loadEl.className = 'container__jsEdit';
  loadEl.innerHTML = '<div class="container__jsInner"><p> Идет загрузка списка комментариев. Подождите! </p></div>';
  const containerDivInner = loadEl.querySelector('.container__jsInner');
  loadEl.setAttribute('style', 'background-color: red; border: 2px solid black; width: 600px; height: 200px; display: flex; align-items: center;');
  containerDivInner.setAttribute('style', 'font-size: 28px; color: white; font-weight: bold; text-align: center;')
  containerEl.classList.add('disabled'); // вся стр
  formEl.style.display = 'none'; // блок добавления комментария

  const formLoadEl = document.createElement('div');
  formLoadEl.className = 'newComment__jsEdit'
  formLoadEl.innerHTML = '<div class ="newComment__jsInner"><p> Идет загрузка нового комментария. Подождите! </p></div>';
  const commentDivInner = formLoadEl.querySelector('.newComment__jsInner');
  formLoadEl.setAttribute('style', 'background-color: red; margin-top: 48px; border: 2px solid black; width: 600px; height: 200px; display: flex; align-items: center;');
  commentDivInner.setAttribute('style', 'font-size: 28px; color: white; font-weight: bold; text-align: center;')
  formLoadEl.style.display = 'none';

  if (navigator.onLine) {
    containerEl.prepend(loadEl);
  }

  let countLikes = 0;

  // const comments = [
  //   {
  //     userName: 'Глеб Фокин',
  //     date: '12.02.22 12:18',
  //     commentText: "Это будет первый комментарий на этой странице",
  //     likes: 3,
  //     isLiked: false
  //   },
  //   {
  //     userName: 'Варвара Н.',
  //     date: '13.02.22 19:22',
  //     commentText: "Мне нравится как оформлена эта страница! ❤",
  //     likes: 75,
  //     isLiked: true
  //   }
  // ];

  let comments = []; // const не дал внести изм в массив
  // из API - под мой формат
  const updateComments = (newComments) => {
    comments = newComments.map((comment) => {
      return {
        id: comment.id,
        userName: comment.author.name,
        date: new Date(comment.date).toLocaleString('ru-RU', {
          day: '2-digit',
          month: '2-digit',
          year: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
        }),
        commentText: comment.text,
        likes: comment.likes,
        isLiked: comment.isLiked,
      }
    })
  };

  function getAPI() {
    return fetch('https://wedev-api.sky.pro/api/v1/lada-yarkova/comments')
      .then((response) => {
        return response.json()
      })
      .then((data) => {
        // console.log(data)
        updateComments(data.comments);
        renderComments(comments);
      }).catch(() => {
        alert("У пользователя пропал интернет");
      }).finally(() => {
        formEl.style.display = 'flex';
        containerEl.classList.remove('disabled');
        loadEl.remove();
      })
  };

  getAPI();

  function renderComments(comments) {
    const container = document.getElementById("commentsContainer");
    container.innerHTML = comments.map((comment, index) =>
      `<li class="comment" data-index="${index}">
        <div class="comment-header">
          <div>${comment.userName}</div>
          <div>${comment.date}</div>
        </div>
        <div class="comment-body">
          <div class="comment-text">${comment.commentText}
          </div>
        </div>
        <div class="comment-footer">
          <div class="likes">
            <span class="likes-counter">${comment.likes}</span>
            <button class="${comment.isLiked ? 'like-button -active-like' : 'like-button'}" data-index="${index}"></button>
          </div>
        </div>
        </li>`).join("")

    initLikes();
    feedbackComments();
  };

  renderComments(comments); // 1 отрисовка - локально показываются данные

  buttonEl.addEventListener('click', () => {
// проверка, чтобы все поля были заполнены
    if (inputEl.value === "") {
      inputEl.style.backgroundColor = "red";
      inputEl.onfocus = function () {
        inputEl.style.backgroundColor = "";
      };
      return;
    }
    if (textEl.value === "") {
      textEl.style.backgroundColor = "red";
      textEl.onfocus = function () {
        textEl.style.backgroundColor = "";
      }
      return;
    }

    comments.push({
      userName: inputEl.value.replaceAll("<", "&lt;").replaceAll(">", "&gt;"),
      date: `${new Date().toLocaleDateString('ru-RU', {
        month: 'numeric',
        day: 'numeric',
        year: '2-digit'
      })} ${new Date().toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
      })}`,
      commentText: textEl.value.replaceAll("<", "&lt;").replaceAll(">", "&gt;"),
      likes: countLikes,
      isLiked: false
    })

    if (navigator.onLine) {
      formEl.style.display = 'none';
      formLoadEl.style.display = 'flex';
      formEl.replaceWith(formLoadEl);
    }

    // renderComments(comments);// 2 отрисовка - локально показывается новый коммент

    // fetch post - перед очищением полей и после рендера
    const handlePostClick = () => {
      fetch('https://wedev-api.sky.pro/api/v1/lada-yarkova/comments', {
        method: "POST",
        body: JSON.stringify({
          text: textEl.value,
          name: inputEl.value,
          forceError: true,
        }),
      }).then((response) => {
        // console.log(response.status);
        if (response.status === 500) {
          throw new Error("Сервер сломался, попробуй позже");
        } else if (response.status === 400) {
          throw new Error("Имя и комментарий должны быть не короче 3 символов");
        }
        return response.json();
      }).then(() => {
        //return Promise.reject('какая-то ошибка') - пример ошибки
        return getAPI();
      })
        //   .then(() => {
        //   return fetch('https://wedev-api.sky.pro/api/v1/lada-yarkova/comments');
        // }).then((response) => {
        //   return response.json();
        // })
        // .then((data) => {
        //   updateComments(data.comments);
        //   renderComments(comments);
        .then(() => {
          // очищение полей для нового ввода, после отрисовки нового комментария и передачи его в post
          inputEl.value = '';
          inputEl.style.backgroundColor = '';
          textEl.value = '';
          textEl.style.backgroundColor = '';
        })
        .catch((error) => {
          if (error.message === "NetworkError when attempting to fetch resource." || error.message === "Failed to fetch") {
            alert("У пользователя пропал интернет");
          } else {
            alert(error.message);
          }

          if (error.message === "Сервер сломался, попробуй позже") {
            handlePostClick();
          }
        })
        .finally(() => {
          formLoadEl.style.display = 'none';
          formEl.style.display = 'flex';
          formLoadEl.replaceWith(formEl);
        })
    }
    handlePostClick();
  });

  function initLikes() {
    const likeButtons = document.querySelectorAll('.like-button');

    for (const likeButton of likeButtons) {
      likeButton.addEventListener('click', (event) => {
        event.stopPropagation() // клик по лайку не должен вызывать feedbackComments
        const index = likeButton.dataset.index;

        /*if (comments[index].isLiked === false) {
          comments[index].isLiked = true;
          comments[index].likes++;
        } else {
          comments[index].isLiked = false;
          comments[index].likes--;
        }
        renderComments(comments); // 3 отрисовка - локально комменты показывают лайк*/
        likeButton.classList.add('-loading-like');

        function delay(interval = 300) {
          return new Promise((resolve) => {
            setTimeout(() => {
              resolve();
            }, interval);
          });
        }

        delay(2000).then(() => {
          if (comments[index].isLiked === false) {
            comments[index].isLiked = true;
            comments[index].likes++;
          } else {
            comments[index].isLiked = false;
            comments[index].likes--;
          }
          likeButton.classList.remove('-loading-like');
          renderComments(comments);
        });
      })
    }
  };

  function feedbackComments() {
    const commentElements = document.querySelectorAll("li");

    for (const commentElement of commentElements) {
      commentElement.addEventListener('click', () => {
        const index = commentElement.dataset.index;
        textEl.value = `> ${comments[index].userName} \n ${comments[index].commentText} \n`;
      })
    }
  };

</script>

</html>